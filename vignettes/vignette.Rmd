---
title: "Exploring Mammal Diversity in Peru with perumammals"
author: "Paul Efren Santos Andrade"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploring Mammal Diversity in Peru with perumammals}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
library(perumammals)
library(dplyr)
library(ggplot2)
library(waffle)
```

## Introduction

Peru is widely recognized as one of the world's megadiverse countries, ranking second in the Neotropics and the Americas for mammalian diversity, with **573 species** across 13 orders (Pacheco et al., 2021).
The `perumammals` package provides direct access to this updated taxonomic dataset, enabling researchers, students, and conservation practitioners to explore, validate, and analyze mammals occurring in Peru.

### Dataset Background

The updated mammalian checklist by Pacheco et al. (2021) compiles:

* **573 species**, **223 genera**, **51 families**, **13 orders**
* **87 endemic species** (15.2% of total)
* Presence across 9 ecoregions, from coastal deserts to Amazonian rainforests
* Continuous updates reflecting recent systematic revisions

The package adopts this taxonomic framework and includes tools for validating species names and handling synonyms or misspelled entries via fuzzy matching.

## Loading the Dataset

```{r load-data}
data("peru_mammals")

glimpse(peru_mammals)

```

## Taxonomic Diversity

### Orders and Species Richness

```{r orders-diversity}
order_summary <- pm_list_orders() |> 
  dplyr::arrange(dplyr::desc(n_species)) |> 
  dplyr::mutate(percentage = round(n_species / sum(n_species) * 100, 1))

order_summary

ggplot(order_summary, 
       aes(x = reorder(order, n_species),
           y = n_species)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = n_species),
            hjust = -0.2, size = 3) +
  coord_flip() +
  labs(
    title = "Mammalian Diversity in Peru by Order",
    subtitle = "Based on Pacheco et al. (2021)",
    x = "Order",
    y = "Number of Species"
  ) +
  theme_minimal()
```

**Rodentia** (194 species) and **Chiroptera** (189 species) together account for nearly **67%** of Peruâ€™s mammalian diversity.

## Endemic Species

```{r endemics}
pm_list_endemic(include_rate = TRUE)
```

**Rodentia** contains the largest number of endemic species (56), representing **64.4%** of all mammalian endemics in Peru.

## Geographic Distribution

### Ecoregional Diversity

```{r ecoregions}

ecoregion_diversity <- pm_list_ecoregions(include_endemic = TRUE)
ecoregion_diversity

# VISUALIZATION
waffle_data <- ecoregion_diversity |> 
  dplyr::select(ecoregion_label, pct_endemic) |> 
  dplyr::mutate(
    Endemic = round(pct_endemic),      # Endemic species (rounded)
    Common = 100 - Endemic             # Common species
  ) |> 
  tidyr::pivot_longer(
    cols = c("Endemic", "Common"),
    names_to = "type",
    values_to = "percentage"
  ) |> 
  dplyr::group_by(ecoregion_label) |> 
  dplyr::mutate(
    total_pct = paste0(round(pct_endemic, 1), "% endemic"),
    ecoregion_full = paste0(ecoregion_label, "\n", total_pct)
  ) |> 
  dplyr::ungroup()

#  Create waffle chart
library(waffle)

 ggplot(waffle_data, 
        aes(fill = type, values = percentage)) +
  geom_waffle(
    n_rows = 10,
    size = 0.4,
    colour = "white",
    flip = TRUE,
    radius = unit(2, "pt")
  ) +
  facet_wrap(~ecoregion_full, nrow = 2, ncol = 5) +
  scale_fill_manual(
    name = NULL,
    values = c(
      "Common" = "#CBD5E1",   
      "Endemic" = "#E07A5F"  
    ),
    labels = c(
      "Common species",
      "Endemic species"
    )
  ) +
  coord_equal() +
  labs(
    title = "Mammal Endemism by Ecoregion in Peru",
    subtitle = "Each square represents 1% of species. The percentage indicates the proportion of endemic species"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(
      face = "bold",
      size = 16,
      hjust = 0.5,
      margin = margin(b = 5)
    ),
    plot.subtitle = element_text(
      hjust = 0.5,
      size = 11,
      color = "gray30",
      margin = margin(b = 20)
    ),
    plot.caption = element_text(
      hjust = 1,
      size = 8,
      color = "gray50",
      margin = margin(t = 15)
    ),
    legend.position = "bottom",
    legend.text = element_text(size = 11),
    legend.key.size = unit(0.8, "cm"),
    legend.margin = margin(t = 15),
    strip.text = element_text(
      size = 9.5,
      face = "bold",
      lineheight = 1.2,
      margin = margin(t = 8, b = 8)
    ),
    plot.margin = margin(20, 20, 20, 20),
    plot.background = element_rect(fill = "white", color = NA),
    panel.spacing = unit(1.5, "lines")
  )

```

The **Selva Baja** contains the highest species richness, while the **Yungas** harbor the greatest number of endemic mammals.

## Name Validation and Fuzzy Matching

```{r fuzzy-matching}
species_list <- c(
  "Tremarctos ornatos",
  "Leopardus pardalis",
  "Odocoileus virginanus",
  "Lagothrix flavicauda",
  "Alouatta seniculus",
  "Puma concolor"
)

validated <- validate_peru_mammals(
  species_list,
  quiet = FALSE
)

validated %>%
  select(Orig.Name, Matched.Name, Match.Level, valid_rank)
```

The fuzzy matching tool corrects common misspellings and returns standardized scientific names while preserving the original input.

## Practical Applications

### Conservation Assessment

```{r conservation-example}
endemic_primates <- peru_mammals %>%
  filter(order == "Primates", endemic == TRUE) %>%
  select(genus, species, common_name)

endemic_primates
```

### Research Data Cleaning

```{r data-cleaning-example}
field_data <- data.frame(
  site = rep(c("Site_A", "Site_B", "Site_C"), each = 3),
  species = c(
    "Tremarctos ornatos", "Mazama rufina", "Odocoileus virginianus",
    "Leopardus pardalis", "Puma concolor", "Leopardus jacobita",
    "Lagothrix flavicauda", "Ateles belzebuth", "Alouatta seniculus"
  ),
  count = c(2, 1, 3, 1, 2, 1, 5, 3, 2)
)

cleaned_data <- field_data %>%
  left_join(
    validate_peru_mammals(field_data$species),
    by = c("species" = "Orig.Name")
  ) %>%
  select(site, original = species, validated = Matched.Name, count, Match.Level)

cleaned_data
```



## Citation

### Package Citation

```{r citation, eval=TRUE}
citation("perumammals")
```


---
