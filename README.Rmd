---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# perumammals <img src="man/figures/logo_perumammals.png" align="right" height="250" width="250"/>
Taxonomic backbone and name validation tools for the mammals of Peru.

<!-- badges: start -->
[![Lifecycle: stable](https://img.shields.io/badge/lifecycle-stable-blue.svg)](https://lifecycle.r-lib.org/articles/stages.html)
[![CRAN status](https://www.r-pkg.org/badges/version/perumammals)](https://CRAN.R-project.org/package=perumammals)
[![](http://cranlogs.r-pkg.org/badges/grand-total/perumammals?color=green)](https://cran.r-project.org/package=perumammals)
[![](http://cranlogs.r-pkg.org/badges/last-week/perumammals?color=green)](https://cran.r-project.org/package=perumammals)
[![R-CMD-check](https://github.com/PaulESantos/perumammals/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/PaulESantos/perumammals/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

---

## Overview

**perumammals** provides a curated, standardized and programmatically accessible
version of the mammal diversity of Peru as compiled by **Pacheco et al. (2021)**: *“Lista actualizada de la diversidad de los mamíferos del Perú y una propuesta para su actualización”.*

This publication represents the most up-to-date and comprehensive synthesis of
Peruvian mammal diversity, integrating taxonomic revisions, biogeographic
information, distributional updates and the evaluation of endemic taxa.

The package includes:

- A **backbone dataset of 573 mammal species** known for Peru (terrestrial, arboreal, aquatic and marine).
- **Taxonomic structure** (Order, Family, Genus, Species, authorship).
- **Endemism** information.
- **Ecoregional occurrence**, following the scheme used by Pacheco et al. (2021).
- **References and taxonomic notes** as listed in the source document.
- Data structures ready for **name validation**, **biodiversity assessments**, 
  **environmental studies**, **species filtering**, and **ecoregional analyses**.

The goal of the package is not to replace authoritative taxonomic databases,
but to provide a **stable, Peruvian-focused backbone** and a set of **reproducible tools** that can be used in ecological, environmental, biogeographic and conservation workflows.

---

## Context from Pacheco et al. (2021)

The backbone included in **perumammals** is derived directly from the annex of **Pacheco et al. (2021)**, who synthesized decades of Peruvian mammalogy work. This list is highly relevant as it incorporates recent taxonomic updates up to November 2021, including the description of species new to science (e.g., Thomasomys antoniobracki, Oligoryzomys guille), the first Peruvian records for some bats (Eumops bonariensis), and species re-validations (e.g., Neacomys carceleni), ensuring users work with the most current classification.

### Mammalian Diversity

- **573 species** documented for Peru.  
- Representing **223 genera**, **51 families**, and **13 orders**.
- Includes both **terrestrial and marine** mammals.
- Peru ranks among the most mammal-diverse countries worldwide.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.alt="."}
library(dplyr)
library(ggplot2)
library(forcats)
library(perumammals)

# Assuming the main package dataset is 'peru_mammals'
data_order_diversity <- perumammals::peru_mammals |> 
  # Group by the 'Order' taxonomic field
  dplyr::group_by(order) |> 
  dplyr::summarise(n_species = n()) |> 
  dplyr::ungroup() |> 
  # Order the factors by species count for plotting
  dplyr::mutate(order = forcats::fct_reorder(order, n_species))

# Generate the plot using ggplot2
ggplot(data_order_diversity, aes(x = order, y = n_species)) +
  geom_bar(stat = "identity", fill = "#3182bd") +
  coord_flip() + # Horizontal bars for better long name readability
  labs(
    title = "Mammal Diversity of Peru by Taxonomic Order",
    subtitle = "Source: Pacheco et al. (2021). Total: 573 species.",
    x = "",
    y = "Number of Species"
  ) +
  theme_minimal() +
  # Add text labels for values
  geom_text(aes(label = n_species), hjust = -0.1, size = 3.5, color = "black") +
  # Adjust Y-axis limit to fit labels
  scale_y_continuous(limits = c(0, max(data_order_diversity$n_species) * 1.1)) +
  theme(plot.title = element_text(face = "bold"))

```


### Endemism

- **87 species** are recognized as **endemic to Peru**, emphasizing the country’s importance for global mammalian conservation.


```{r echo=FALSE, fig.alt="."}

library(dplyr)
library(ggplot2)
library(forcats)
library(scales) 
  
# Get the list of endemic species names
  endemic_names <- pm_endemics() |> 
    dplyr::pull(scientific_name)
  
  endemic_percent <- peru_mammals_ecoregions |> 
    dplyr::mutate(
      Endemic_Status = ifelse(scientific_name %in% endemic_names, "Endemic", "Non-Endemic")
    ) |> 
    dplyr::group_by(ecoregion_code, Endemic_Status) |> 
    dplyr::summarise(Count = n_distinct(scientific_name), .groups = 'drop') |> 
    dplyr::left_join(peru_mammals_ecoregions_meta, by = "ecoregion_code") |> 
    dplyr::group_by(ecoregion_label) |> 
    dplyr::mutate(
      Total_Count = sum(Count),
      Proportion = Count / Total_Count,
      Label_Text = scales::percent(Proportion, accuracy = 0.1)
    ) |> 
    dplyr::ungroup() |> 
    dplyr::mutate(
      ecoregion_label = forcats::fct_reorder(ecoregion_label, Total_Count)
    ) 
  
  # Generate the stacked percentage bar plot
  
ggplot(endemic_percent, 
       aes(x = ecoregion_label, y = Count, fill = Endemic_Status)) +
    geom_bar(stat = "identity", position = "fill") +
    coord_flip() +
    scale_y_continuous(labels = scales::percent) + 
    scale_fill_manual(
      values = c("Endemic" = "#e34a33", "Non-Endemic" = "#cccccc"),
      name = ""
    ) +
    geom_text(
      aes(label = Label_Text),
      position = position_fill(vjust = 0.5), 
      size = 3.5,
      color = "black" 
    ) +
    labs(
      title = "Proportion of Endemic Mammal Species by Ecoregion",
      x = "",
      y = "Species Proportion (%)"
    ) +
    theme_minimal() +
    theme(plot.title = element_text(face = "bold"),
          legend.position = "bottom")
  

```


### Biogeographic Ecoregions

The article assigns each species to one or more Peruvian ecoregions using 
the classification widely used in biogeography and conservation planning:

```{r echo=FALSE}
pm_list_ecoregions()
```

These codes are incorporated into the package as both:

- part of the main species table, and  
- a dedicated long-format table for analytical workflows.

### Taxonomic Notes and Updates

Pacheco et al. (2021) incorporate:

- New species records and recent taxonomic revisions.
- Updates resulting from molecular phylogenetics and integrative taxonomy.
- Clarifications regarding problematic or doubtful taxa.
- Contextual notes on species with uncertain distributions.

---

## What the Package Provides

Although `perumammals` contains functions for name validation and exploration.

The package includes four main datasets:

### **1. `peru_mammals`**
A species-level backbone with:

- Taxonomy (Order, Family, Genus, Species).
- Authorship information.
- Common names when available.
- Endemic status.
- Ecoregion assignments.
- Bibliographic notes.

### **2. `peru_mammals_ecoregions`**
A long-format dataset listing species–ecoregion pairs, ideal for:

- diversity summaries,
- mapping,
- ecoregional filters,
- conservation prioritization.

### **3. `peru_mammals_ecoregions_meta`**
Metadata describing the ecoregion codes used across the package.

### **4. `peru_mammals_backbone`**
Metadata describing:

- the source (Pacheco et al. 2021),
- year of publication,
- number of species,
- date of dataset creation during package build.

These datasets make `perumammals` a lightweight but powerful reference for any
workflow requiring curated and Peruvian-focused mammal information.


### Core Functions and Name Validation

| Category | Functionality | Conceptual Code Example |
|----------|---------------|-------------------------|
| Name Validation | Validate species names against database | `validate_peru_mammals(c("Thomasomys notatus", "Tapirus terrestris", "Unknown species"))` |
| Quick Checks | Check if species occurs in Peru | `is_peru_mammal("Tremarctos ornatus")` |
| Endemism Query | Check endemic status | `is_endemic_peru("Thomasomys notatus")` |
| Match Quality | Get validation match level | `match_quality_peru("Puma concolar")` |
| Family Summary | List families with species counts | `pm_list_families()` |
| Family Filter | Filter by specific family | `pm_species(family = "Cricetidae")` |
| Endemic Analysis | List endemic species statistics | `pm_list_endemic()` |
| Endemic by Family | Filter endemics by family | `pm_endemics(family = "Phyllostomidae")` |
| Endemic by Ecoregion | Filter endemics by ecoregion | `pm_by_ecoregion(ecoregion = "YUN", endemic = TRUE)` |


---

## Installation

```r
# Development version from GitHub
# Using pak (recommended)
pak::pak("PaulESantos/perumammals")

# Or using remotes
remotes::install_github("PaulESantos/perumammals")

```

## Citation

If you use this package, please cite:

The package:

```{r}

citation("perumammals")

```
